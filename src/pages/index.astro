---
import fallbackUrl from "../images/fondo.jpg?url";
const BASE = import.meta.env.BASE_URL;
const BG = "https://eldiarioderiobamba.com/wp-content/uploads/2020/04/pref.png";
const REPORT_URL = "https://drive.google.com/drive/folders/1pCdLpMYkc0LuTLon9OdR9sefd0s9sJjd?usp=sharing";

const isServerAuthed =
  Boolean(Astro.cookies.get("sb-access-token")?.value) &&
  Boolean(Astro.cookies.get("sb-refresh-token")?.value);


const SOCIAL = {
  facebook: "https://www.facebook.com/PrefecturaChimborazo",
  youtube:  "https://www.youtube.com/@hermeltayupandacuvi7806",
  tiktok:   "https://www.tiktok.com/@hermeltayupandaprefecto?_t=8eU5CzH0OFJ&_r=1",
};
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Página Principal</title>


    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

    <style>
      :root{ --nav-h:64px; --radius:22px; --ring:1px solid rgba(255,255,255,.48); }
      html,body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; }
      .navbar.glass{ background:rgba(255,255,255,.16)!important; backdrop-filter:blur(10px) saturate(120%); border-bottom:1px solid rgba(0,0,0,.06); }
      .pill{ border-radius:999px; padding:.5rem 1rem; }
      .hero{ position:relative; isolation:isolate; min-height:100svh; padding-top:calc(var(--nav-h) + 24px); display:grid; place-items:start center; overflow:hidden; background:#0b1736; }
      .hero>img.bg{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; object-position:center; z-index:0; pointer-events:none; }
      .glass-card{ position:relative; z-index:1; width:min(920px,94vw); text-align:center; color:#111; background:rgba(255,255,255,.28); backdrop-filter:blur(8px) saturate(120%); border:var(--ring); border-radius:var(--radius); padding:clamp(16px,3vw,28px); box-shadow:0 18px 48px rgba(0,0,0,.18); margin-top:12vh; }
      @media (max-width:991.98px){ .glass-card{ margin-top:8vh; } }


      .social-btn{
        width:40px; height:40px; border-radius:999px;
        display:flex; align-items:center; justify-content:center;
        border:1px solid rgba(0,0,0,.35);
        background:rgba(255,255,255,.85);
        transition:transform .15s ease, background .15s ease;
      }
      .social-btn i{ font-size:1.15rem; color:#111; }
      .social-btn:hover{ transform:translateY(-2px); background:#fff; }


      .social-btn.lg{ width:48px; height:48px; }
      .social-btn.lg i{ font-size:1.35rem; }


      footer.social-footer{
        background:rgba(255,255,255,.6);
        backdrop-filter:blur(8px) saturate(120%);
        border-top:1px solid rgba(0,0,0,.08);
      }
    </style>
  </head>

  <body data-base={BASE} data-auth={isServerAuthed ? "1" : "0"}>
    <nav class="navbar navbar-expand-lg glass fixed-top">
      <div class="container">
        <a class="navbar-brand fw-bold" href={BASE} style="color:#111;">PREFECTURA DE CHIMBORAZO</a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-label="Menú">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="mainNav">
          <ul class="navbar-nav ms-auto align-items-lg-center gap-2">
            <li class="nav-item"><a class="btn btn-light btn-outline-dark pill" href="#inicio">Inicio</a></li>
            <li class="nav-item"><a id="btnReporte" class="btn btn-light btn-outline-dark pill" href={REPORT_URL} target="_blank" rel="noopener">Reporte</a></li>
            <li class="nav-item"><a id="btnDash" class="btn btn-light btn-outline-dark pill" href={`${BASE}menu`}>Dashboard</a></li>
            <li class="nav-item ms-lg-2"><a id="btnAuth" class="btn btn-primary pill" href={`${BASE}signin`}>Iniciar sesión</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <header id="inicio" class="hero">
      <img class="bg" src={BG} alt="Fondo" loading="eager" decoding="async" onerror={`this.onerror=null; this.src='${fallbackUrl}';`} />
      <div class="glass-card">
        <h1 class="display-5 m-0">Bienvenidos</h1>
      </div>
    </header>

  
    <footer class="social-footer">
      <div class="container py-4">
        <div class="d-flex justify-content-center align-items-center gap-3">
          <a class="social-btn lg" href={SOCIAL.facebook} target="_blank" rel="noopener" aria-label="Facebook">
            <i class="bi bi-facebook"></i>
          </a>
          <a class="social-btn lg" href={SOCIAL.youtube} target="_blank" rel="noopener" aria-label="YouTube">
            <i class="bi bi-youtube"></i>
          </a>
          <a class="social-btn lg" href={SOCIAL.tiktok} target="_blank" rel="noopener" aria-label="TikTok">
            <i class="bi bi-tiktok"></i>
          </a>
        </div>
      </div>
    </footer>
    <!-- Si quieres que quede SIEMPRE pegado: <footer class="social-footer fixed-bottom"> -->

    <script is:inline>
      (function () {
        const AUTH_KEY = "auth:ok";
        const base = document.body.dataset.base || "/";
        const serverAuth = document.body.dataset.auth === "1";

        if (serverAuth) localStorage.setItem(AUTH_KEY, "1");

        const isAuth = () => localStorage.getItem(AUTH_KEY) === "1";

        const btnAuth    = document.getElementById("btnAuth");
        const btnDash    = document.getElementById("btnDash");
        const btnReporte = document.getElementById("btnReporte");

        function updateAuthUI() {
          if (isAuth()) {
            btnAuth.textContent = "Cerrar sesión";
            btnAuth.href = "#";
            btnAuth.onclick = (e) => {
              e.preventDefault();
              fetch(base + "api/auth/signout", { method: "POST" }).catch(()=>{});
              localStorage.removeItem(AUTH_KEY);
              location.href = base;
            };
          } else {
            btnAuth.textContent = "Iniciar sesión";
            btnAuth.href = base + "signin?next=" + encodeURIComponent(base);
            btnAuth.onclick = null;
          }
        }

        function guard(e, url, openNewTab) {
          if (isAuth()) {
            if (openNewTab) window.open(url, "_blank", "noopener");
            else window.location.href = url;
          } else {
            e.preventDefault();
            alert("Debes iniciar sesión");
            window.location.href = base + "signin?next=" + encodeURIComponent(base);
          }
        }

        btnDash.addEventListener("click",    (e) => guard(e, btnDash.getAttribute("href"), false));
        btnReporte.addEventListener("click", (e) => guard(e, btnReporte.getAttribute("href"), true));

        updateAuthUI();
        document.addEventListener("visibilitychange", () => { if (!document.hidden) updateAuthUI(); });
      })();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
