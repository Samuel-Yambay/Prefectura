---
import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabaseClient';
import GsIframe from '../components/GsIframe';
const accessToken = Astro.cookies.get('sb-access-token');
const refreshToken = Astro.cookies.get('sb-refresh-token');

if (!accessToken || !refreshToken) {
  return Astro.redirect('/signin');
}

let session;
try {
  session = await supabase.auth.setSession({
    refresh_token: refreshToken.value,
    access_token: accessToken.value,
  });

  if (session.error) {
    Astro.cookies.delete('sb-access-token', { path: '/' });
    Astro.cookies.delete('sb-refresh-token', { path: '/' });
    return Astro.redirect('/signin');
  }
} catch (error) {
  Astro.cookies.delete('sb-access-token', { path: '/' });
  Astro.cookies.delete('sb-refresh-token', { path: '/' });
  return Astro.redirect('/signin');
}

const email = session.data.user?.email;
// 1. Obtén el enlace de EMBED del Google Form.
// Ve a tu Google Form, haz clic en "Enviar", luego en la pestaña "<>" (embed/incrustar),
// y copia el código HTML del iframe. Necesitarás el atributo `src`.
// Ejemplo: "https://docs.google.com/forms/d/e/TU_ID_DE_FORMULARIO/viewform?embedded=true"
//
// 2. Para ocultar los menús y herramientas de Google Sheets (no de Google Forms):
// Si el iframe fuera directamente una hoja de cálculo, podrías intentar añadir
// `&rm=minimal` al final de la URL si se trata de un documento de Google Sheets
// para "minimizar" la interfaz. Sin embargo, para **Google Forms**,
// el `embedded=true` ya hace gran parte del trabajo de mostrar solo el formulario.
// Si lo que realmente querías era incrustar una HOJA DE CÁLCULO sin menús,
// la URL sería diferente y se añadiría `&rm=minimal` y posiblemente `&headers=false&chrome=false`.
//
// **Dado que estás incrustando un FORMULARIO de Google (viewform?embedded=true),
// este ya está diseñado para mostrar solo el formulario.**
// Si el enlace que proporcionaste
// `https://docs.google.com/spreadsheets/d/10c2rUQnxlfuBsFyAj8kxuhkPUNFk6fPqnnQ2EWFCL5I/edit?usp=sharing/viewform?embedded=true`
// es en realidad un enlace a una HOJA DE CÁLCULO, necesitas primero CREAR un Google Form
// a partir de esa hoja o con datos para ella, y luego obtener el enlace de incrustación de ese *formulario*.
//
// **Asumiendo que el enlace anterior es un ERROR y que realmente es un Google Form,
// aquí está el formato correcto. Reemplaza `TU_ID_DE_FORMULARIO` con el ID real de tu form.**
const googleFormEmbedUrl = "https://docs.google.com/forms/d/e/TU_ID_DE_FORMULARIO/viewform?embedded=true";
---
<style>
  body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background-color: #f9f9f9;
  }

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #0d1b2a; /* azul oscuro */
    color: white;
    padding: 1rem 2rem;
    border-bottom: 4px solid #E63946; /* línea roja */
  }

  .header .left,
  .header .right {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .header button,
  .header a {
    background-color: #1D3557;
    color: white;
    padding: 0.5rem 1rem;
    text-decoration: none;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  .header button:hover,
  .header a:hover {
    background-color: #E63946;
  }

  .report-container {
    height: calc(100vh - 80px); /* resta la altura del header */
    overflow: hidden;
  }

  iframe {
    width: 100%;
    height: 100%;
    border: none;
  }
</style>

<div class="header">
  <div class="left">
    <h2>Dashboard</h2>
    <a href="/dashboard">Actualizar</a>
    <a href="/reporte">Reporte</a>
    <a href="/sorteo">Actividades</a>
  </div>
  <div class="right">
    <form action="/api/auth/signout" method="post">
      <button type="submit">Salir</button>
    </form>
  </div>
</div>
<div class="report-container">
    <iframe
    src="https://docs.google.com/spreadsheets/d/10c2rUQnxlfuBsFyAj8kxuhkPUNFk6fPqnnQ2EWFCL5I/edit?usp=sharing?widget=false&headers=false&rm=minimal&single=true&embedded=true#gid=104705847"
    
    ></iframe>
</div>
